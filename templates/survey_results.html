<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒæŸ¥ç»“æœç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .position-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .position-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .ranking-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .ranking-table tr:hover {
            background: #f8f9fa;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .feedback-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .feedback-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feedback-player {
            font-weight: 600;
            color: #333;
        }

        .feedback-time {
            color: #666;
            font-size: 12px;
        }

        .feedback-content {
            color: #555;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .empty-message {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-bottom: 5px;
            }

            .ranking-table {
                font-size: 14px;
            }

            .ranking-table th,
            .ranking-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è°ƒæŸ¥ç»“æœç®¡ç†</h1>
            <p>æŸ¥çœ‹ç©å®¶è°ƒæŸ¥æ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalParticipants">-</div>
                <div class="stat-label">æ€»å‚ä¸äººæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayParticipants">-</div>
                <div class="stat-label">ä»Šæ—¥å‚ä¸äººæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFeedbacks">-</div>
                <div class="stat-label">ç•™è¨€åé¦ˆæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgRankings">-</div>
                <div class="stat-label">å¹³å‡æ’åæ•°</div>
            </div>
        </div>

        <button class="export-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>

        <div class="tabs">
            <button class="tab active" data-tab="rankings">ğŸ† æ’åç»Ÿè®¡</button>
            <button class="tab" data-tab="feedbacks">ğŸ’¬ ç•™è¨€åé¦ˆ</button>
            <button class="tab" data-tab="raw-data">ğŸ“‹ åŸå§‹æ•°æ®</button>
        </div>

        <div class="tab-content active" id="rankings-tab">
            <div class="loading" id="rankingsLoading">æ­£åœ¨åŠ è½½æ’åæ•°æ®...</div>
            <div id="rankingsContent"></div>
        </div>

        <div class="tab-content" id="feedbacks-tab">
            <div class="loading" id="feedbacksLoading">æ­£åœ¨åŠ è½½ç•™è¨€æ•°æ®...</div>
            <div id="feedbacksContent"></div>
        </div>

        <div class="tab-content" id="raw-data-tab">
            <div class="loading" id="rawDataLoading">æ­£åœ¨åŠ è½½åŸå§‹æ•°æ®...</div>
            <div id="rawDataContent"></div>
        </div>
    </div>

    <script>
        class SurveyResultsManager {
            constructor() {
                this.data = null;
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadData();
            }

            setupEventListeners() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });
            }

            switchTab(tabName) {
                // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });

                // æ›´æ–°å†…å®¹æ˜¾ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}-tab`);
                });

                // åŠ è½½å¯¹åº”æ•°æ®
                this.loadTabData(tabName);
            }

            async loadData() {
                try {
                    console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                    
                    const [statsResponse, resultsResponse] = await Promise.all([
                        fetch('http://localhost:5101/api/survey/stats'),
                        fetch('http://localhost:5101/api/survey/results')
                    ]);

                    console.log('APIå“åº”çŠ¶æ€:', statsResponse.status, resultsResponse.status);

                    const stats = await statsResponse.json();
                    const results = await resultsResponse.json();

                    console.log('è§£æçš„æ•°æ®:', { stats, results });

                    if (stats.success && results.success) {
                        this.data = { stats: stats, results: results };
                        this.updateStats();
                        this.loadTabData('rankings');
                        console.log('æ•°æ®åŠ è½½æˆåŠŸ');
                    } else {
                        throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    this.showError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            updateStats() {
                const { stats, results } = this.data;
                
                document.getElementById('totalParticipants').textContent = stats.total_participants;
                document.getElementById('todayParticipants').textContent = stats.today_participants;
                
                // è®¡ç®—ç•™è¨€åé¦ˆæ•°
                const feedbackCount = results.surveys.filter(s => s.feedback && s.feedback.trim()).length;
                document.getElementById('totalFeedbacks').textContent = feedbackCount;
                
                // è®¡ç®—å¹³å‡æ’åæ•°
                let totalRankings = 0;
                let totalSurveys = 0;
                results.surveys.forEach(survey => {
                    Object.values(survey.rankings).forEach(rankings => {
                        totalRankings += rankings.length;
                    });
                    totalSurveys++;
                });
                const avgRankings = totalSurveys > 0 ? Math.round(totalRankings / totalSurveys) : 0;
                document.getElementById('avgRankings').textContent = avgRankings;
            }

            loadTabData(tabName) {
                switch (tabName) {
                    case 'rankings':
                        this.renderRankings();
                        break;
                    case 'feedbacks':
                        this.renderFeedbacks();
                        break;
                    case 'raw-data':
                        this.renderRawData();
                        break;
                }
            }

            renderRankings() {
                const content = document.getElementById('rankingsContent');
                const loading = document.getElementById('rankingsLoading');
                
                if (!this.data) {
                    loading.style.display = 'block';
                    content.innerHTML = '';
                    return;
                }

                loading.style.display = 'none';
                
                const { position_stats } = this.data.results;
                const positions = ['C', 'PF', 'SF', 'SG', 'PG', 'SW'];
                
                content.innerHTML = positions.map(position => {
                    const stats = position_stats[position];
                    if (!stats || Object.keys(stats).length === 0) {
                        return `
                            <div class="position-section">
                                <h3 class="position-title">${this.getPositionName(position)}</h3>
                                <div class="empty-message">æš‚æ— æ’åæ•°æ®</div>
                            </div>
                        `;
                    }

                    // æŒ‰å¹³å‡æ’åæ’åº
                    const sortedChars = Object.values(stats).sort((a, b) => a.avg_rank - b.avg_rank);
                    
                    return `
                        <div class="position-section">
                            <h3 class="position-title">${this.getPositionName(position)}</h3>
                            <table class="ranking-table">
                                <thead>
                                    <tr>
                                        <th>æ’å</th>
                                        <th>è§’è‰²åç§°</th>
                                        <th>ä»£é™…</th>
                                        <th>å¹³å‡æ’å</th>
                                        <th>æŠ•ç¥¨æ•°</th>
                                        <th>æ’ååˆ†å¸ƒ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedChars.map((char, index) => `
                                        <tr>
                                            <td>
                                                <span class="rank-badge">${index + 1}</span>
                                            </td>
                                            <td>${char.name}</td>
                                            <td>${char.gen}ä»£è¶…ç‰¹</td>
                                            <td><strong>${char.avg_rank}</strong></td>
                                            <td>${char.total_votes}</td>
                                            <td>${this.formatRankDistribution(char.rankings)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }).join('');
            }

            renderFeedbacks() {
                const content = document.getElementById('feedbacksContent');
                const loading = document.getElementById('feedbacksLoading');
                
                if (!this.data) {
                    loading.style.display = 'block';
                    content.innerHTML = '';
                    return;
                }

                loading.style.display = 'none';
                
                const feedbacks = this.data.results.surveys
                    .filter(survey => survey.feedback && survey.feedback.trim())
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                if (feedbacks.length === 0) {
                    content.innerHTML = '<div class="empty-message">æš‚æ— ç•™è¨€åé¦ˆ</div>';
                    return;
                }

                content.innerHTML = `
                    <div class="feedback-list">
                        ${feedbacks.map(feedback => `
                            <div class="feedback-item">
                                <div class="feedback-header">
                                    <span class="feedback-player">
                                        ${feedback.player_id || 'åŒ¿åç©å®¶'}
                                    </span>
                                    <span class="feedback-time">
                                        ${new Date(feedback.created_at).toLocaleString('zh-CN')}
                                    </span>
                                </div>
                                <div class="feedback-content">${feedback.feedback}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderRawData() {
                const content = document.getElementById('rawDataContent');
                const loading = document.getElementById('rawDataLoading');
                
                if (!this.data) {
                    loading.style.display = 'block';
                    content.innerHTML = '';
                    return;
                }

                loading.style.display = 'none';
                
                const surveys = this.data.results.surveys;
                
                if (surveys.length === 0) {
                    content.innerHTML = '<div class="empty-message">æš‚æ— è°ƒæŸ¥æ•°æ®</div>';
                    return;
                }

                content.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 20px; color: #333;">åŸå§‹è°ƒæŸ¥æ•°æ® (å…±${surveys.length}æ¡)</h3>
                        <div style="max-height: 500px; overflow-y: auto;">
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.4;">${JSON.stringify(surveys, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }

            getPositionName(position) {
                const names = {
                    'C': 'ä¸­é”‹ (C)',
                    'PF': 'å¤§å‰é”‹ (PF)',
                    'SF': 'å°å‰é”‹ (SF)',
                    'SG': 'å¾—åˆ†åå« (SG)',
                    'PG': 'æ§çƒåå« (PG)',
                    'SW': 'æ‘‡æ‘†äºº (SW)'
                };
                return names[position] || position;
            }

            formatRankDistribution(rankings) {
                const distribution = {};
                rankings.forEach(rank => {
                    distribution[rank] = (distribution[rank] || 0) + 1;
                });
                
                return Object.entries(distribution)
                    .sort(([a], [b]) => parseInt(a) - parseInt(b))
                    .map(([rank, count]) => `ç¬¬${rank}å:${count}æ¬¡`)
                    .join(', ');
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.stats-grid'));
            }
        }

        function exportData() {
            if (!window.surveyManager || !window.surveyManager.data) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const data = window.surveyManager.data;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_results_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.surveyManager = new SurveyResultsManager();
        });
    </script>
</body>
</html>
